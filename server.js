require('dotenv').config();
const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const { GoogleGenerativeAI } = require('@google/generative-ai');

const app = express();
const port = 3000;

// ë¯¸ë“¤ì›¨ì–´ ì„¤ì •
app.use(cors());
app.use(bodyParser.json());
app.use(express.static('public')); // public í´ë”ì˜ html ì„œë¹™

// Gemini API ì„¤ì •
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

// [ë°ì´í„°] ì—°ë ¹ë³„ ë§žì¶¤ ì‹œë‚˜ë¦¬ì˜¤ (ì „ë¬¸ìš©ì–´ ë°°ì œ ë° ìˆ˜ì¤€ ì¡°ì ˆ)
const SCENARIOS = {
    elementary: {
        target: "ì´ˆë“±í•™ìƒ",
        background: "ìš°ë¦¬ í•™êµëŠ” ì§€êµ¬ë¥¼ ì§€í‚¤ê¸° ìœ„í•´ ì•žìœ¼ë¡œ 1ë…„ ì•ˆì— ê¸‰ì‹ì‹¤ì—ì„œ í”Œë¼ìŠ¤í‹± ì‹íŒê³¼ ìˆŸê°€ë½ì„ ì—†ì• ê³ , ê³„ì† ì“¸ ìˆ˜ ìžˆëŠ” ê·¸ë¦‡ìœ¼ë¡œ ëª¨ë‘ ë°”ê¾¸ê¸°ë¡œ ì•½ì†í–ˆì–´ìš”.",
        problems: [
            "1. ëˆ ë¬¸ì œ: ìƒˆë¡œìš´ ê·¸ë¦‡ì„ ì‚¬ê³  ì„¤ê±°ì§€ ê¸°ê³„ë¥¼ ì„¤ì¹˜í•˜ëŠ” ë° ëˆì´ ë§Žì´ ë“¤ì–´ìš”.",
            "2. ì¼í•˜ëŠ” ë¶„ë“¤ì˜ ì–´ë ¤ì›€: ì„¤ê±°ì§€ê°€ ë„ˆë¬´ ë§Žì•„ì ¸ì„œ ì¡°ë¦¬ì‚¬ë‹˜ë“¤ì´ ë„ˆë¬´ íž˜ë“¤ê³ , ë°¥ ë¨¹ëŠ” ì‹œê°„ë„ ëŠ¦ì–´ì§ˆ ìˆ˜ ìžˆì–´ìš”.",
            "3. í•™ìƒë“¤ì˜ ë¶ˆíŽ¸í•¨: ìƒˆ ì‹íŒì´ ë¬´ê±°ì›Œì„œ ë“¤ê¸° íž˜ë“¤ê³ , ë°¥ ë¨¹ê³  ì •ë¦¬í•˜ëŠ” ì‹œê°„ì´ ë” ì˜¤ëž˜ ê±¸ë ¤ìš”."
        ],
        requirements: [
            "1. ë¯¸ëž˜ ìƒìƒí•˜ê¸°: 5ë…„ ë’¤ ìš°ë¦¬ í•™êµê°€ ì–´ë–»ê²Œ ë³€í• ì§€ ì¢‹ì€ ì ê³¼ ë‚˜ìœ ì ì„ ìƒìƒí•´ë³´ì„¸ìš”.",
            "2. ë§ˆìŒ ë‚˜ëˆ„ê¸°: ì¡°ë¦¬ì‚¬ë‹˜ê³¼ ì¹œêµ¬ë“¤ ì‚¬ì´ì—ì„œ ì˜ê²¬ì´ ë‹¤ë¥¼ ë•Œ ì–´ë–»ê²Œ ê³µí‰í•˜ê²Œ í•´ê²°í•  ìˆ˜ ìžˆì„ê¹Œìš”?",
            "3. ìž‘ì „ ì§œê¸°: ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ 3ê°€ì§€ ì•„ì´ë””ì–´ì™€ ëˆ/ë°˜ëŒ€ ì˜ê²¬ì„ í•´ê²°í•  ë°©ë²•ì„ ì ì–´ì£¼ì„¸ìš”.",
            "4. íŒ€ ë§Œë“¤ê¸°: ì¹œêµ¬ë“¤ê³¼ ì–´ë–»ê²Œ íŒ€ì„ ê¾¸ë¦´ì§€, ê·¸ë¦¬ê³  ë¦¬ë”ì¸ ë‚´ê°€ ì§€ì¹˜ì§€ ì•Šìœ¼ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í• ì§€ ì ì–´ì£¼ì„¸ìš”."
        ]
    },
    middle: {
        target: "ì¤‘í•™ìƒ",
        background: "ìš°ë¦¬ í•™êµëŠ” í™˜ê²½ ë³´í˜¸ë¥¼ ì‹¤ì²œí•˜ê¸° ìœ„í•´ 1ë…„ ë‚´ì— ê¸‰ì‹ì‹¤ì˜ ëª¨ë“  ì¼íšŒìš© í”Œë¼ìŠ¤í‹±ì„ ì—†ì• ê³ , ë‹¤íšŒìš© ì‹ê¸°ë¡œ ì „ë©´ êµì²´í•˜ëŠ” 'í”Œë¼ìŠ¤í‹± ì œë¡œ' í”„ë¡œì íŠ¸ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤.",
        problems: [
            "1. ì˜ˆì‚° ë¬¸ì œ: ì‹ê¸° êµ¬ë§¤ì™€ ì„¸ì²™ê¸° ì„¤ì¹˜ ë¹„ìš©, ê·¸ë¦¬ê³  ìˆ˜ë„/ì „ê¸° ìš”ê¸ˆì´ ë§Žì´ ë‚˜ì˜µë‹ˆë‹¤.",
            "2. ì¡°ë¦¬ì‚¬ë‹˜ë“¤ì˜ ê³ ì¶©: ì„¤ê±°ì§€ ì–‘ì´ ì—„ì²­ë‚˜ê²Œ ëŠ˜ì–´ë‚˜ì„œ ì¡°ë¦¬ ì‹¤ë¬´ìžë¶„ë“¤ì´ ë„ˆë¬´ íž˜ë“¤ê³ , ë°°ì‹ë„ ëŠ¦ì–´ì§ˆ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.",
            "3. í•™ìƒë“¤ì˜ ë¶ˆë§Œ: ì‹íŒì´ ë¬´ê±°ì›Œì§€ê³ , ìž”ë°˜ ì²˜ë¦¬ë‚˜ ì •ë¦¬ì— ì‹œê°„ì´ ë” ê±¸ë ¤ì„œ ë¶ˆíŽ¸í•´í•©ë‹ˆë‹¤."
        ],
        requirements: [
            "1. ë¬¸ì œ ë¶„ì„ê³¼ ë¯¸ëž˜: ì´ ë³€í™”ê°€ í•™êµì— ë¯¸ì¹  ì˜í–¥ê³¼ 5ë…„ í›„ì˜ ê¸ì •ì /ë¶€ì •ì  ëª¨ìŠµì„ ì˜ˆì¸¡í•´ ë³´ì„¸ìš”.",
            "2. ê°€ì¹˜ ê°ˆë“± í•´ê²°: ì„œë¡œ ë‹¤ë¥¸ ìž…ìž¥ì„ ê°€ì§„ ì‚¬ëžŒë“¤ ì‚¬ì´ì—ì„œ ì–´ë–»ê²Œ ê³µì •í•˜ê²Œ ë¬¸ì œë¥¼ í•´ê²°í• ì§€ ê¸°ì¤€ì„ ì„¸ì›Œë³´ì„¸ìš”.",
            "3. ì „ëžµê³¼ ì‹¤í–‰: í•µì‹¬ ì „ëžµ 3ê°€ì§€ì™€ ì˜ˆì‚° ë¶€ì¡±ì´ë‚˜ ë°˜ëŒ€ë¥¼ ê·¹ë³µí•  êµ¬ì²´ì ì¸ ë°©ë²•ì„ ì œì‹œí•˜ì„¸ìš”.",
            "4. í˜‘ë ¥ê³¼ ê´€ë¦¬: íŒ€ì„ ì–´ë–»ê²Œ ìš´ì˜í• ì§€, ê·¸ë¦¬ê³  ë¦¬ë”ë¡œì„œ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì–´ë–»ê²Œ ê´€ë¦¬í• ì§€ ê³„íší•´ ë³´ì„¸ìš”."
        ]
    },
    high: { // ê³ ë“±í•™ìƒ, ëŒ€í•™ìƒ, ì„±ì¸ì€ ì›ë³¸ ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜ (ë‹¨, ìš©ì–´ëŠ” ëŒ€ìƒì— ë§žì¶° ë¯¸ì„¸ ì¡°ì • ê°€ëŠ¥í•˜ë‚˜ ì—¬ê¸°ì„  ì›ë³¸ ìœ ì§€)
        target: "ê³ ë“±í•™ìƒ/ëŒ€í•™ìƒ/ì„±ì¸",
        background: "ê·€í•˜ê°€ ë‹¤ë‹ˆëŠ” í•™êµ(ê¸°ê´€)ëŠ” í™˜ê²½ ë³´í˜¸ì™€ ì§€ì†ê°€ëŠ¥í•œ ì†Œë¹„ ê°€ì¹˜ë¥¼ ì‹¤í˜„í•˜ê¸° ìœ„í•´, 1ë…„ ì•ˆì— ê¸‰ì‹ì‹¤ì˜ ì¼íšŒìš©í’ˆì„ ì „ë©´ ë°°ì œí•˜ê³  ë‹¤íšŒìš© ì‹ê¸°ë¡œ êµì²´í•˜ëŠ” 'í”Œë¼ìŠ¤í‹± ì œë¡œ í”„ë¡œì íŠ¸'ë¥¼ ì¶”ì§„í•©ë‹ˆë‹¤.",
        problems: [
            "1. ê²½ì œ/í–‰ì •: ì‹ê¸° êµ¬ë§¤ ë° ì„¸ì²™ê¸° ì„¤ì¹˜ ì˜ˆì‚° ë°œìƒ, ìš´ì˜ë¹„(ìˆ˜ë„Â·ì „ê¸°) ì¦ê°€.",
            "2. ì‚¬íšŒ/ë…¸ë™: ì„¸ì²™ ì—…ë¬´ëŸ‰ í­ì¦ìœ¼ë¡œ ì¡°ë¦¬ ì‹¤ë¬´ìž ë…¸ë™ ê°•ë„ ì‹¬í™”, ìœ„ìƒ ìš°ë ¤ ë° ë°°ì‹ ì§€ì—°.",
            "3. ì´ìš©ìž: ì‹íŒ ë¬´ê²Œ ì¦ê°€, ìž”ë°˜ ì²˜ë¦¬ ë° ì‹ê¸° ì •ë¦¬ ì‹œê°„ ì¦ê°€ë¡œ ì¸í•œ ë¶ˆíŽ¸ í˜¸ì†Œ."
        ],
        requirements: [
            "1. ë¬¸ì œ ë¶„ì„ ë° ë¯¸ëž˜ ì˜ˆì¸¡: ì‹œìŠ¤í…œ ì „ì²´ ì˜í–¥ ë° 5ë…„ í›„ì˜ ê¸ì •/ë¶€ì •ì  ì‹œë‚˜ë¦¬ì˜¤ ë„ì¶œ.",
            "2. ê°€ì¹˜ ë° ìœ¤ë¦¬: ì´í•´ê´€ê³„ìž ê°„ ê°€ì¹˜ ì¶©ëŒ ì‹ë³„ ë° ê³µì •í•˜ê³  ìœ¤ë¦¬ì ì¸ í•´ê²°ì±…(Trade-off) ì œì‹œ.",
            "3. ë³€í˜ ì „ëžµ ë° ì‹¤í–‰: í•µì‹¬ ì „ëžµ 3ê°€ì§€ì™€ ìž¥ì• ë¬¼(ì˜ˆì‚°, ë°˜ëŒ€) ê·¹ë³µì„ ìœ„í•œ êµ¬ì²´ì  í–‰ë™ ê³„íš.",
            "4. í˜‘ë ¥ ë° ìžê¸° ê´€ë¦¬: íŒ€ êµ¬ì„±/ìš´ì˜ ë°©ì•ˆ ë° ë¦¬ë”ì˜ ì†Œì§„(Burnout) ë°©ì§€ ê³„íš."
        ]
    }
};

// 1. ì‹œë‚˜ë¦¬ì˜¤ ìš”ì²­ API
app.post('/api/scenario', (req, res) => {
    const { level } = req.body;
    let selectedScenario;

    if (level === 'elementary') selectedScenario = SCENARIOS.elementary;
    else if (level === 'middle') selectedScenario = SCENARIOS.middle;
    else selectedScenario = SCENARIOS.high;

    res.json(selectedScenario);
});

// 2. í‰ê°€ ìš”ì²­ API (Gemini ì—°ë™)
app.post('/api/evaluate', async (req, res) => {
    const { level, userResponse, scenarioData } = req.body;

    try {
        const model = genAI.getGenerativeModel({ model: "gemini-pro" });

        const prompt = `
        ë‹¹ì‹ ì€ 'ì§€ì†ê°€ëŠ¥ì„± ë³€í™” ì£¼ë„ í”„ë¡œì íŠ¸'ì˜ ì—„ê²©í•œ ì „ë¬¸ í‰ê°€ìžì´ìž ì½”ì¹˜ìž…ë‹ˆë‹¤.
        í•™ìŠµìž(${scenarioData.target})ê°€ ìž‘ì„±í•œ [í•™êµ ê¸‰ì‹ 'í”Œë¼ìŠ¤í‹± ì œë¡œ' ì „í™˜ í”„ë¡œì íŠ¸] ê³„íšì„œë¥¼ í‰ê°€í•´ì•¼ í•©ë‹ˆë‹¤.

        [í‰ê°€ ì›ì¹™]
        1. ì ˆëŒ€ ë¬´ì¡°ê±´ ì¹­ì°¬í•˜ì§€ ë§ˆì‹­ì‹œì˜¤. ëƒ‰ì² í•˜ê²Œ ë¶„ì„í•˜ì„¸ìš”.
        2. ì•„ëž˜ '8ê°€ì§€ í•µì‹¬ ì—­ëŸ‰ í‰ê°€ ê¸°ì¤€'ì„ ì—„ê²©ížˆ ì ìš©í•˜ì—¬ ì ìˆ˜ë¥¼ ë§¤ê¸°ì„¸ìš”.
        3. í•™ìŠµìžì˜ ì—°ë ¹(${scenarioData.target})ì„ ê³ ë ¤í•˜ì—¬ í”¼ë“œë°±ì˜ ë§íˆ¬ëŠ” ì´í•´í•˜ê¸° ì‰½ê²Œ í•˜ë˜, í‰ê°€ ê¸°ì¤€(ì ìˆ˜) ìžì²´ëŠ” íƒ€í˜‘í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
        
        [8ê°€ì§€ í•µì‹¬ ì—­ëŸ‰ í‰ê°€ ê¸°ì¤€ (Rubric)]
        1. ì‹œìŠ¤í…œì‚¬ê³ : í™˜ê²½-ê²½ì œ-ì‚¬íšŒ 3ê°€ì§€ ì˜ì—­ì˜ ìˆœí™˜ì  ì¸ê³¼ê´€ê³„ë‚˜ ìƒì¶© ê´€ê³„(Trade-off) ì„¤ëª… ì—¬ë¶€ (ë‹¨ìˆœ ë‚˜ì—´ì€ ê°ì )
        2. ë¯¸ëž˜ì‚¬ê³ : 5ë…„ í›„ ì‹œë‚˜ë¦¬ì˜¤ì˜ êµ¬ì²´ì„± ë° 'ì˜ë„í•˜ì§€ ì•Šì€ ë¶€ìž‘ìš©'ì— ëŒ€í•œ ì‚¬ì „ ì˜ˆë°©ì±… ìœ ë¬´
        3. ê°€ì¹˜ì‚¬ê³ : 'ì •ì˜ë¡œìš´ ì „í™˜', 'í˜•í‰ì„±' ë“± ìœ¤ë¦¬ì  ê¸°ì¤€ ì ìš© ë° ëª…í™•í•œ íƒ€í˜‘ ê¸°ì¤€ ì œì‹œ
        4. ì „ëžµì  ì‚¬ê³ : ì „ëžµì˜ ì‹¤í˜„ ê°€ëŠ¥ì„±ê³¼ ìž¥ì• ë¬¼(ì˜ˆì‚°, ë°˜ëŒ€)ì— ëŒ€í•œ ì‹¤ì§ˆì  ê·¹ë³µ ë°©ì•ˆ
        5. ì‹¤ì²œ ì—­ëŸ‰: ëˆ„ê°€(Who), ì–¸ì œ(When), ì–´ë–»ê²Œ(How)ê°€ ëª…í™•í•˜ê³  ì£¼ë„ì ì¸ì§€
        6. ëŒ€ì¸ê´€ê³„ ì—­ëŸ‰: ê°ˆë“± ê´€ê³„ì¸ ì´í•´ê´€ê³„ìž(ì¡°ë¦¬ ì‹¤ë¬´ìž ë“±)ë¥¼ íŒŒíŠ¸ë„ˆë¡œ í¬ìš©í•˜ê³  ê³µê°í•˜ëŠ”ì§€
        7. ìžê¸°ì´í•´ ì—­ëŸ‰: ìžì‹ ì˜ í•œê³„(ë©”íƒ€ì¸ì§€)ë¥¼ ì•Œê³  êµ¬ì²´ì ì¸ íšŒë³µ íƒ„ë ¥ì„±/ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ ë°©ì•ˆì´ ìžˆëŠ”ì§€
        8. í†µí•©ì  ë¬¸ì œí•´ê²°ë ¥: ìœ„ 7ê°€ì§€ê°€ ë…¼ë¦¬ì  ëª¨ìˆœ ì—†ì´ í•˜ë‚˜ë¡œ ì—°ê²°ë˜ëŠ”ì§€

        [í•™ìŠµìžê°€ ë³´ê³  ìž‘ì„±í•œ ì‹œë‚˜ë¦¬ì˜¤]
        ë°°ê²½: ${scenarioData.background}
        ë¬¸ì œ: ${scenarioData.problems.join(', ')}
        
        [í•™ìŠµìžì˜ ë‹µë³€]
        ${userResponse}

        ---------------------------------------------------------
        [ì¶œë ¥ í˜•ì‹] (Markdown í˜•ì‹ í•„ìˆ˜)

        ## ðŸ“Š [ì§€ì†ê°€ëŠ¥ì„± í•µì‹¬ì—­ëŸ‰ ì§„ë‹¨ ì„±ì í‘œ]

        | í•µì‹¬ ì—­ëŸ‰ | ì ìˆ˜ (5ì  ë§Œì ) | ìƒì„¸ í‰ê°€ ë° í”¼ë“œë°± |
        | :--- | :---: | :--- |
        | **ì‹œìŠ¤í…œì‚¬ê³ ** | â­â­â­ (3/5) | (í‰ê°€ ë‚´ìš©) |
        | **ë¯¸ëž˜ì‚¬ê³ ** | ... | ... |
        ... (8ê°œ í•­ëª© ëª¨ë‘ ìž‘ì„±) ...

        ## ðŸ’¡ ì´í‰ ë° ì½”ì¹­
        * **ê°•ì :** (ë†’ì€ ì ìˆ˜ í•­ëª© ì¹­ì°¬)
        * **ë³´ì™„ì :** (ë‚®ì€ ì ìˆ˜ í•­ëª©ì— ëŒ€í•´ 'ìƒ' ë“±ê¸‰ì„ ë°›ê¸° ìœ„í•œ êµ¬ì²´ì ì´ê³  ì‹¤ì²œì ì¸ ì¡°ì–¸. ${scenarioData.target} ëˆˆë†’ì´ì— ë§žì¶° ì„¤ëª…)
        `;

        const result = await model.generateContent(prompt);
        const response = await result.response;
        const text = response.text();

        res.json({ result: text });

    } catch (error) {
        console.error("Error calling Gemini API:", error);
        res.status(500).json({ error: "í‰ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
    }
});

app.listen(port, () => {
    console.log(`Server running at http://localhost:${port}`);
});