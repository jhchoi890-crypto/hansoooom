require('dotenv').config();
const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const { GoogleGenerativeAI } = require('@google/generative-ai');

const app = express();
// Render 배포 시 포트 자동 할당 대응
const port = process.env.PORT || 3000;

app.use(cors());
app.use(bodyParser.json());
app.use(express.static('public'));

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

// [데이터] 연령별 시나리오 (기존과 동일)
const SCENARIOS = {
    elementary: {
        target: "초등학생",
        background: "우리 학교는 지구를 지키기 위해 앞으로 1년 안에 급식실에서 플라스틱 식판과 숟가락을 없애고, 계속 쓸 수 있는 그릇으로 모두 바꾸기로 약속했어요.",
        problems: [
            "1. 돈 문제: 새로운 그릇을 사고 설거지 기계를 설치하는 데 돈이 많이 들어요.",
            "2. 일하는 분들의 어려움: 설거지가 너무 많아져서 조리사님들이 너무 힘들고, 밥 먹는 시간도 늦어질 수 있어요.",
            "3. 학생들의 불편함: 새 식판이 무거워서 들기 힘들고, 밥 먹고 정리하는 시간이 더 오래 걸려요."
        ],
        requirements: [
            "1. 미래 상상하기: 5년 뒤 우리 학교가 어떻게 변할지 좋은 점과 나쁜 점을 상상해보세요.",
            "2. 마음 나누기: 조리사님과 친구들 사이에서 의견이 다를 때 어떻게 공평하게 해결할 수 있을까요?",
            "3. 작전 짜기: 이 문제를 해결하기 위한 3가지 아이디어와 돈/반대 의견을 해결할 방법을 적어주세요.",
            "4. 팀 만들기: 친구들과 어떻게 팀을 꾸릴지, 그리고 리더인 내가 지치지 않으려면 어떻게 해야 할지 적어주세요."
        ]
    },
    middle: {
        target: "중학생",
        background: "우리 학교는 환경 보호를 실천하기 위해 1년 내에 급식실의 모든 일회용 플라스틱을 없애고, 다회용 식기로 전면 교체하는 '플라스틱 제로' 프로젝트를 시작합니다.",
        problems: [
            "1. 예산 문제: 식기 구매와 세척기 설치 비용, 그리고 수도/전기 요금이 많이 나옵니다.",
            "2. 조리사님들의 고충: 설거지 양이 엄청나게 늘어나서 조리 실무자분들이 너무 힘들고, 배식도 늦어질 수 있습니다.",
            "3. 학생들의 불만: 식판이 무거워지고, 잔반 처리나 정리에 시간이 더 걸려서 불편해합니다."
        ],
        requirements: [
            "1. 문제 분석과 미래: 이 변화가 학교에 미칠 영향과 5년 후의 긍정적/부정적 모습을 예측해 보세요.",
            "2. 가치 갈등 해결: 서로 다른 입장을 가진 사람들 사이에서 어떻게 공정하게 문제를 해결할지 기준을 세워보세요.",
            "3. 전략과 실행: 핵심 전략 3가지와 예산 부족이나 반대를 극복할 구체적인 방법을 제시하세요.",
            "4. 협력과 관리: 팀을 어떻게 운영할지, 그리고 리더로서 스트레스를 어떻게 관리할지 계획해 보세요."
        ]
    },
    high: {
        target: "고등학생/대학생/성인",
        background: "귀하가 다니는 학교(기관)는 환경 보호와 지속가능한 소비 가치를 실현하기 위해, 1년 안에 급식실의 일회용품을 전면 배제하고 다회용 식기로 교체하는 '플라스틱 제로 프로젝트'를 추진합니다.",
        problems: [
            "1. 경제/행정: 식기 구매 및 세척기 설치 예산 발생, 운영비(수도·전기) 증가.",
            "2. 사회/노동: 세척 업무량 폭증으로 조리 실무자 노동 강도 심화, 위생 우려 및 배식 지연.",
            "3. 이용자: 식판 무게 증가, 잔반 처리 및 식기 정리 시간 증가로 인한 불편 호소."
        ],
        requirements: [
            "1. 문제 분석 및 미래 예측: 시스템 전체 영향 및 5년 후의 긍정/부정적 시나리오 도출.",
            "2. 가치 및 윤리: 이해관계자 간 가치 충돌 식별 및 공정하고 윤리적인 해결책(Trade-off) 제시.",
            "3. 변혁 전략 및 실행: 핵심 전략 3가지와 장애물(예산, 반대) 극복을 위한 구체적 행동 계획.",
            "4. 협력 및 자기 관리: 팀 구성/운영 방안 및 리더의 소진(Burnout) 방지 계획."
        ]
    }
};

app.post('/api/scenario', (req, res) => {
    const { level } = req.body;
    let selectedScenario = SCENARIOS.high;
    if (level === 'elementary') selectedScenario = SCENARIOS.elementary;
    if (level === 'middle') selectedScenario = SCENARIOS.middle;
    res.json(selectedScenario);
});

// [평가 요청 API] - PPT 기반 정밀 채점 로직 적용
app.post('/api/evaluate', async (req, res) => {
    const { level, userResponse, scenarioData } = req.body;

    try {
        // 모델명 수정: gemini-pro (구버전) -> gemini-2.5-flash (안정적, 빠름)
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        const prompt = `
        당신은 '지속가능성 변화 주도 프로젝트'의 엄격한 전문 평가자입니다. 
        사용자(${scenarioData.target})가 작성한 계획서를 아래의 [5점 척도 루브릭]에 따라 냉철하게 채점하세요.
        **점수는 후하게 주지 마십시오.** 각 기준에 정확히 부합할 때만 점수를 부여하세요.

        ---

        ### [평가 기준: 지속가능성 핵심역량 5점 척도]
        (단국대학교 통합과학교육연구소 '지속가능성 핵심역량 진단도구' 기반)

        **1. 시스템사고 (Systems-Thinking)**
        * **1점(매우 미흡):** 문제의 단면(예: 비용만)만 봄. 연결성 언급 없음.
        * **2점(미흡):** 환경-경제-사회 중 1~2가지만 단순 나열함.
        * **3점(보통):** 3가지 영역을 모두 언급했으나, 연결이 단선적임(A→B).
        * **4점(우수):** 요소 간의 **상호작용**을 설명함. (예: 노동 강도 증가가 위생 문제로 이어짐)
        * **5점(탁월):** **피드백 루프(Feedback Loop)**나 **순환적 인과관계**를 논리적으로 도출함. (A가 B에 영향을 주고, B가 다시 A를 악화시키는 구조 분석)

        **2. 미래사고 (Futures-Thinking)**
        * **1점:** 미래 예측이 없거나 비현실적 낙관론.
        * **2점:** 단순한 미래(좋아질 것이다/나빠질 것이다)만 서술.
        * **3점:** 5년 후의 모습을 긍정/부정으로 나누어 예측함.
        * **4점:** **백캐스팅(Backcasting)** 관점이 보임(미래 목표를 위해 현재 무엇을 해야 하는지 연결).
        * **5점:** **'의도하지 않은 부작용(Unintended Consequences)'**까지 예측하고, 이에 대한 구체적인 사전 예방책(Precautionary measures)을 제시함.

        **3. 가치사고 (Values-Thinking)**
        * **1점:** 가치 갈등을 인식하지 못함.
        * **2점:** "서로 양보해야 한다"는 식의 추상적 도덕론.
        * **3점:** 이해관계자(조리사, 학생, 학교) 간의 입장 차이를 명확히 식별함.
        * **4점:** **형평성(Equity)**과 **정의(Justice)**의 관점에서 누구를 우선할지 기준을 세움.
        * **5점:** **가치 충돌(Trade-off)** 상황에서 양쪽을 중재할 수 있는 구체적이고 혁신적인 **타협안**이나 **보상 체계**를 제시함.

        **4. 전략적 사고 (Strategic-Thinking)**
        * **1점:** 전략이 없거나 비현실적임.
        * **2점:** 단순 캠페인, 포스터 부착 등 소극적 활동에 그침.
        * **3점:** 구체적인 전략 3가지를 제시했으나 장애물 극복 방안이 약함.
        * **4점:** 예산 부족, 반대 여론 등 **장애물(Obstacles)**에 대한 실질적 대안이 있음.
        * **5점:** 전략이 **혁신적**이며, **실행 가능성(Viability)**과 지속 가능성이 매우 높게 설계됨.

        **5. 실천 역량 (Action Competence)**
        * **1점:** "학교가 알아서 해야 한다" 등 주체가 타인임.
        * **2점:** 본인의 의지는 있으나 방법이 모호함.
        * **3점:** 누가(Who), 언제(When), 무엇을(What) 할지가 명시됨.
        * **4점:** **과학적/객관적 근거**에 기반하여 행동을 계획함.
        * **5점:** 일회성 행동이 아니라, **지속적인 실천**을 위한 시스템(모니터링, 동아리 창설 등)을 구축함.

        **6. 대인관계 역량 (Interpersonal Competence)**
        * **1점:** 갈등을 회피하거나 독단적으로 결정함.
        * **2점:** 설득의 대상으로만 타인을 바라봄.
        * **3점:** 팀원 및 이해관계자와 소통하려는 계획이 있음.
        * **4점:** 반대하는 사람(조리 실무자 등)의 고충에 **공감(Empathy)**하고 경청하는 자세가 보임.
        * **5점:** **공감적 리더십**을 발휘하여 갈등 관계자를 **핵심 파트너**로 참여시키는 협력적 구조를 설계함.

        **7. 자기이해 역량 (Intrapersonal Competence)**
        * **1점:** 스트레스나 소진 가능성을 부정함.
        * **2점:** "잠을 잔다", "게임한다" 등 일시적 해소법만 제시.
        * **3점:** 자신의 한계와 스트레스 상황을 인지(메타인지)함.
        * **4점:** 업무 분장, 멘토링 요청 등 **구체적인 관리 방안**이 있음.
        * **5점:** **회복 탄력성(Resilience)**을 유지하고, 리더로서의 **내적 평화**와 **성찰(Self-reflection)**을 위한 루틴이 체계적임.

        **8. 통합적 문제해결력 (Integration Competence)**
        * **1점:** 내용 간 모순이 있거나 질문을 누락함.
        * **2점:** 각 답변이 분절되어 있고 연결성이 부족함.
        * **3점:** 7가지 역량이 전반적으로 무난하게 작성됨.
        * **4점:** 다양한 관점(환경, 경제, 윤리)을 융합하여 해결책을 제시함.
        * **5점:** 분석-가치-전략-실천이 **논리적 완결성**을 갖추고 유기적으로 통합되어 있음.

        ---

        [학습자가 보고 작성한 시나리오]
        ${JSON.stringify(scenarioData)}
        
        [학습자의 답변]
        ${userResponse}

        ---
        [출력 지침]
        1. Markdown 표 형식으로 **점수(X/5)**와 **냉철한 평가(이유)**를 작성하세요.
        2. 총평에서는 **강점**과 더 높은 점수를 받기 위한 **구체적인 코칭(보완점)**을 제공하세요.
        3. 말투는 ${scenarioData.target}에게 말하듯 친절하되, 내용은 전문적이어야 합니다.
        `;

        const result = await model.generateContent(prompt);
        const response = await result.response;
        const text = response.text();

        res.json({ result: text });

    } catch (error) {
        console.error("Gemini API Error:", error);
        res.status(500).json({ error: "AI 평가 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요." });
    }
});

app.listen(port, () => {
    console.log(`Server running on port ${port}`);
});
