<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ì†ê°€ëŠ¥ì„± ë³€í™” ì£¼ë„ í”„ë¡œì íŠ¸ ì½”ì¹˜</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #f4f7f6; font-family: 'Noto Sans KR', sans-serif; }
        .container { max-width: 900px; margin-top: 40px; margin-bottom: 40px; }
        .scenario-box { background-color: #ffffff; border-left: 5px solid #28a745; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .result-box { background-color: #fff; padding: 30px; border-radius: 10px; border: 1px solid #ddd; margin-top: 30px; display: none; }
        .loader { display: none; text-align: center; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        th, td { border: 1px solid #dee2e6; padding: 0.75rem; vertical-align: middle; }
        th { background-color: #e9ecef; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-center mb-4">ğŸŒ± ì§€ì†ê°€ëŠ¥ì„± í”„ë¡œì íŠ¸ ì½”ì¹˜</h1>
    <p class="text-center text-muted">í•™êµ ê¸‰ì‹ 'í”Œë¼ìŠ¤í‹± ì œë¡œ' í”„ë¡œì íŠ¸ì˜ íŒ€ì¥ì´ ë˜ì–´ ê³„íšì„ ì„¸ì›Œë³´ì„¸ìš”.</p>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">STEP 1. ì°¸ê°€ì ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”</h5>
            <div class="row g-2">
                <div class="col-md-3">
                    <select id="levelSelect" class="form-select">
                        <option value="elementary">ì´ˆë“±í•™ìƒ</option>
                        <option value="middle">ì¤‘í•™ìƒ</option>
                        <option value="high">ê³ ë“±í•™ìƒ/ëŒ€í•™ìƒ/ì¼ë°˜</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="loadScenario()">ì‹œì‘í•˜ì!</button>
                </div>
            </div>
        </div>
    </div>

    <div id="scenarioSection" style="display: none;">
        <div class="scenario-box mb-4">
            <h4 class="mb-3">ğŸ“¢ í”„ë¡œì íŠ¸ ì‹œë‚˜ë¦¬ì˜¤</h4>
            <div id="scenarioContent">
                </div>
        </div>

        <div class="mb-4">
            <label for="userAnswer" class="form-label fw-bold">âœï¸ ë‹¹ì‹ ì˜ ê³„íšì„ ì‘ì„±í•´ì£¼ì„¸ìš” (4ê°€ì§€ ìš”êµ¬ì‚¬í•­ í¬í•¨)</label>
            <textarea class="form-control" id="userAnswer" rows="10" placeholder="ì—¬ê¸°ì— ê³„íšì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”."></textarea>
        </div>

        <div class="d-grid gap-2">
            <button class="btn btn-success btn-lg" onclick="submitAnswer()">í‰ê°€ ë°›ê¸°</button>
        </div>
    </div>

    <div class="loader" id="loader">
        <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">ì „ë¬¸ê°€ AIê°€ ë‹¹ì‹ ì˜ ê³„íšì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br>(ì•½ 10~20ì´ˆ ì†Œìš”)</p>
    </div>

    <div id="resultSection" class="result-box">
        </div>
</div>

<script>
    let currentScenarioData = null;

    async function loadScenario() {
        const level = document.getElementById('levelSelect').value;
        
        try {
            const response = await fetch('/api/scenario', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ level })
            });
            
            const data = await response.json();
            currentScenarioData = data;
            
            // ì‹œë‚˜ë¦¬ì˜¤ ë Œë”ë§
            let html = `<h5><strong>[ë°°ê²½]</strong></h5><p>${data.background}</p>`;
            html += `<h5><strong>[ë¬¸ì œ ìƒí™©]</strong></h5><ul>${data.problems.map(p => `<li>${p}</li>`).join('')}</ul>`;
            html += `<h5><strong>[ìš”êµ¬ ì‚¬í•­]</strong></h5><ul>${data.requirements.map(r => `<li>${r}</li>`).join('')}</ul>`;
            
            document.getElementById('scenarioContent').innerHTML = html;
            document.getElementById('scenarioSection').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('userAnswer').value = ''; // ì´ˆê¸°í™”

        } catch (error) {
            alert('ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            console.error(error);
        }
    }

    async function submitAnswer() {
        const answer = document.getElementById('userAnswer').value;
        const level = document.getElementById('levelSelect').value;

        if (answer.trim().length < 20) {
            alert("ë‚´ìš©ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ê³„íšì„ ì ì–´ì£¼ì„¸ìš”!");
            return;
        }

        // UI ìƒíƒœ ë³€ê²½
        document.getElementById('loader').style.display = 'block';
        document.getElementById('resultSection').style.display = 'none';

        try {
            const response = await fetch('/api/evaluate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    level: level, 
                    userResponse: answer,
                    scenarioData: currentScenarioData
                })
            });

            const data = await response.json();
            
            // Markdown ë Œë”ë§í•˜ì—¬ ê²°ê³¼ í‘œì‹œ
            const resultDiv = document.getElementById('resultSection');
            resultDiv.innerHTML = marked.parse(data.result);
            resultDiv.style.display = 'block';

        } catch (error) {
            alert('í‰ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            console.error(error);
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }
</script>

</body>
</html>